<!DOCTYPE html>
<html lang="ko"> 
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>메인 페이지</title>
        <style>
            .container {
                width: 800px !important;
            }
            input {
                width: 100px;
            }
            th {
                background-color: #f8f8f8 !important;
                text-align: center !important;
            }
            td {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-12 pt-5">
                    <div class="card mb-4">
                        <h5 class="card-header text-center">메인 페이지</h5>
                        <div class="card-body">
                            <div class="col-md-12 text-center">
                                <table width="80%" style="margin: auto; text-align: center;">
                                    <tr>
                                        <td>예보지점 x값(nx)</td>
                                        <td><input type="text" id="nx" name="nx" value="" /></td>
                                        <td>예보지점 y값(ny)</td>
                                        <td><input type="text" id="ny" name="ny" value="" /></td>
                                    </tr>
                                    <tr>
                                        <td>baseDate</td>
                                        <td><input type="text" id="baseDate" name="baseDate" value="" /></td>
                                        <td>baseTime</td>
                                        <td><input type="text" id="baseTime" name="baseTime" value="" /></td>
                                    </tr>
                                </table>
                                <br />
                                <button type="button" class="btn btn-outline-success" id="btn_weather">날씨 예보 조회</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" id="result">
                <div class="col-md-12">
                    <table class="table table-bordered" id="resultTable" style="display: none;">
                        <colgroup>
                            <col width="150px">
                            <col width="150px">
                            <col width="150px">
                            <col width="150px">
                            <col width="150px">
                            <col width="150px">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>일자</th>
                                <th>시간</th>
                                <th>날씨</th>
                                <th>강수형태</th>
                                <th>기온</th>
                                <th>습도</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        
        <script>
            $(document).ready(function(){
                $("#btn_weather").click(function(){
                    if ($("#nx").val() == "") {
                        alert("nx 값을 입력하세요.");
                        $("#nx").focus();
                        return false;
                    }
                    
                    if ($("#ny").val() == "") {
                        alert("ny 값을 입력하세요.");
                        $("#ny").focus();
                        return false;
                    }
                    
                    if ($("#baseDate").val() == "") {
                        alert("baseDate 값을 입력하세요.");
                        $("#baseDate").focus();
                        return false;
                    }
                    
                    if ($("#baseTime").val() == "") {
                        alert("baseTime 값을 입력하세요.");
                        $("#baseTime").focus();
                        return false;
                    }
 
                    let data = {
                        nx: $("#nx").val()
                        , ny: $("#ny").val()
                        , baseDate: $("#baseDate").val()
                        , baseTime: $("#baseTime").val()
                    }
                                        
                    $.ajax({
                        url: '/getWeather',
                        type: 'POST',
                        data: JSON.stringify(data),
                        dataType: 'json',
                        contentType: 'application/json',
                        success: function (data) {
                            let jsonObj = JSON.parse(data.resultData);
                            
                            if (jsonObj.response.header.resultCode == "00") {
                                $("#resultTable tbody").html("");
                                $("#resultTable").show();
                                
                                let items = jsonObj.response.body.items.item;
                                if (items.length > 0) {
                                    // 6시간 데이터를 제공
                                    const row = 6;
                                    
                                    // 추출 데이터 (하늘상태, 강수형태, 기온, 습도)
                                    let categoryList = ["SKY", "PTY", "T1H", "REH"];
                                    
                                    // 2차원 배열 생성
                                    let arr = new Array(row);
                                    for (let i = 0; i < arr.length; i++) {
                                        arr[i] = new Array(6);
                                    }
                                    
                                    // 기상청 데이터에서 필요한 데이터 추출
                                    let k = 0;  // categoryList index
                                    let y = 0;  // arr row
                                    let x = 0;  // arr column
                                    for (let i = 0; i < items.length; i++) {
                                        if (categoryList[k] == items[i].category) {
                                            arr[y][x]       = date_format(items[i].fcstDate);
                                            arr[y][x+1]     = time_format(items[i].fcstTime);
                                            arr[y][x+k+2]   = code_value(items[i].category, items[i].fcstValue);
                                            y++;
                                        }
 
                                        if (y == row) {
                                            k++;
                                            y = 0;
                                            i = 0;
                                        }
                                    }
 
                                    let headerRow = "";
                                    for (let y = 0; y < arr[0].length; y++) {
                                        headerRow = $("<tr></tr>");
                                        for (let x = 0; x < arr.length; x++) {
                                            headerRow.append("<td>" + arr[y][x] + "</td>");
                                        }
                                        $("#resultTable tbody").append(headerRow);
                                    }
                                }
                            }
                            else {
                                // api 응답 오류
                            }
                        }
                    });
                    
                    // 날짜 포맷
                    date_format = function(str) {
                        return [str.slice(0, 4), ".", str.slice(4, 6), ".", str.slice(6, 8)].join('');
                    }
                    
                    // 시간 포맷
                    time_format = function(str) {
                        return [str.slice(0, 2), ":", str.slice(2, 4)].join('');
                    }
                    
                    // categoryList 코드 값 변환
                    code_value = function(category, code) {
                        let value = code;
                        if (category == "SKY") {
                            if (code == "1") {
                                value = "맑음";
                            }
                            else if (code == "3") {
                                value = "구름많음";
                            }
                            else if (code == "4") {
                                value = "흐림";
                            }
                        }
                        else if (category == "PTY") {
                            if (code == "1") {
                                value = "비";
                            }
                            else if (code == "2") {
                                value = "비/눈";
                            }
                            else if (code == "3") {
                                value = "눈";
                            }
                            else if (code == "5") {
                                value = "빗방울";
                            }
                            else if (code == "6") {
                                value = "빗방울눈날림";
                            }
                            else if (code == "7") {
                                value = "눈날림";
                            }
                            else {
                                value = "-";
                            }
                        }
                        else if (category == "T1H") {
                            value = code + "℃";
                        }
                        else if (category == "REH") {
                            value = code + "%";
                        }
                        
                        return value;
                    }
                }) 
            });
        </script>
    </body>
</html>